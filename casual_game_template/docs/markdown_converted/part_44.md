# Androidコード署名・Google Play Console・第11章まとめ

## 11.3 アプリの配布とコード署名（続き）

❶開発者がキーストアを作成する
❷開発者が❶のキーストアを使い、アプリに署名をする
❸署名済みの❷のアプリをGoogle Play Consoleにアップロードする
❹Google Play Consoleがアプリの署名を検証する
❺Google Play Consoleが生成・管理するキーストアでアプリを再署名する
❻再署名済みのアプリをGoogle Play Storeに配布する

❶で作成したキーストアの秘密鍵をアップロード鍵、❺でGoogle Play Consoleが生成・管理するキーストアの秘密鍵をアプリ署名鍵と呼びます。

Androidはアプリをアップデート（新しいバージョンのアプリを上書きインストール）する際に、同じ証明書で署名されている必要があります。証明書を紛失してしまうと、アプリのアップデートができなくなってしまいます。そのため、ユーザーの手もとで検証される証明書をGoogle Play Consoleがクラウド上で管理することで、リスクを軽減しているのです。

手順が非常に多いように見えますが、実際にはAndroid StudioのGUIを使って簡単に行うことができます。

### apkファイルとaabファイル

Androidのプロジェクトは、apkファイルとaabファイルの2種類のファイルを生成することができます。インストール可能なアプリのファイル形式はapkファイルです。aabはAndroid App Bundleの略で、そのままではインストールできません。aabはコンパイル済みのコードとリソースをすべて内包したファイルで、インストールする端末向けにaabから最適化したapkファイルを生成することができます。

Google Playで公開するアプリは、aabの形式でのアップロードしかサポートされていません。Google Play Consoleがaabファイルをapkファイルに変換、その際にアプリ署名鍵で署名を行い、ユーザーの端末にインストールされるのです。

### アプリに署名する

それでは、アップロード鍵の生成とアプリへの署名手順を解説します。Android Studioを使うと簡単に行えます。

プロジェクトルート直下のandroidディレクトリをAndroid Studioで開きます。アプリケーションメニューの「Build」→「Generate Signed Bundle/APK」を選択します。

ダイアログで「Android App Bundle」を選択し、「Next」をクリックします（図11.16）。

**図11.16 ファイル形式の選択ダイアログ**

次の画面で「Create new...」を選択し、アップロード鍵を生成します（図11.17）。

**図11.17 署名設定のダイアログ**

図11.18のダイアログの上部から、「Key store path:」にはキーストアの保存先を指定します。ファイルの拡張子は「.jks」を指定します。「Password:」と「Confirm:」にはキーストアのパスワードを入力します。「Alias:」には鍵を識別する任意の名前を入力します。その下の「Password:」と「Confirm:」には先ほどのキーストアのパスワードと同じものを入力します。「Validity (years):」は鍵の有効期限を指定します。25年以上が推奨されています。「Certificate」には証明書の所有者情報を入力します。ストアで公開されることはありませんが、証明書の情報としてアプリに組み込まれます。

「OK」をクリックすると、キーストアが生成されます。

**図11.18 キーストア作成ダイアログ**

もとのダイアログ（図11.17）に戻ったら「Next」をクリックします。

次の画面では「release」を選択し、「Create」をクリックします（図11.19）。

ビルドが完了すると、android/app/releaseディレクトリにaabファイルが生成されます。

**図11.19 ビルドバリアントの選択ダイアログ**

### aabファイルをアップロードする

実際にaabファイルをGoogle Play Consoleにアップロードし、処理される様子を見てみましょう。aabファイルをアップロードするために、Google Play Consoleでアプリの情報登録などの操作が必要になりますが、その操作については駆け足で説明します。本項はアプリの署名にフォーカスした内容のためご容赦ください。

Google Play Consoleにログインし、右上の「アプリを作成」をクリックします（図11.20）。

**図11.20 Google Play Consoleのトップ画面**

アプリの必要情報を入力し、「アプリを作成」をクリックします（図11.21）。

**図11.21 Google Play Consoleのアプリ作成画面**

左側のメニューに「製品版」のほか、「テスト」の配下に「オープンテスト」や「クローズドテスト」などがあります（図11.22）。

**図11.22 Google Play Consoleのダッシュボード画面**

「製品版」はGoogle Playで公開中のバージョンを管理する画面です。アプリを「製品版」として公開する前にテスターに配布するなどの用途で「テスト」以下の項目を使います。今回はアップロードの動作を見ることを目的に「内部テスト」を選択します。「内部テスト」をクリックし、右上の「新しいリリースを作成」をクリックします（図11.23）。

**図11.23 Google Play Consoleの内部テスト画面**

図11.24の画面で「署名鍵を選択」をクリックすると、署名鍵の選択ダイアログが表示されます（図11.25）。「Google生成の鍵を使用」を選択します。

**図11.24 Google Play Consoleのリリース作成画面**

**図11.25 署名鍵の選択ダイアログ**

図11.24の画面に戻ったら「アップロード」をクリックすると、ファイル選択ダイアログが表示されますので、先ほど生成したaabファイルを選択します。続いて「リリースの詳細」に必要事項を入力し、「次へ」をクリックします。

右下の「保存して公開」をクリックすると、内部テストのリリースが作成されます。

aabファイルのアップロードが完了しました。これで先ほどアプリをビルドする際に作成したキーストアがアップロード鍵として自動的に登録されます。次回以降のアップロードでは、同じキーストアを使ってビルドしなければアップロード時にエラーとなります。

---

## 11.4 まとめ

Flutterアプリを開発するうえで欠かせないiOS、Androidネイティブの知識を解説しました。SwiftやKotlinに触れずともFlutterアプリを開発することは可能ですが、本章で紹介したアプリIDや最低サポートOSバージョンの設定などは、欠かすことのできない知識です。

また、アプリの署名に関しては、時にはネイティブアプリエンジニアも苦戦することのある難しいものと筆者は感じています。本章の内容が、みなさんのFlutterアプリをリリースする一助になれば幸いです。