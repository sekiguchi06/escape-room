# 公式ドキュメント準拠修正計画

## 修正方針

### 基本原則
1. **公式ドキュメント最優先**: 推測実装の完全排除
2. **段階的修正**: 重要度順の系統的修正
3. **破綻回避**: 動作する状態を常時維持
4. **方針変更時**: 作業停止してユーザー判断を仰ぐ

### 修正優先順位

## Phase 1: 緊急対応（即座実行）

### 🔴 P1-1: Flame内部API修正
**対象**: `lib/game/simple_game.dart:26-32`

**現在の問題実装**:
```dart
// ❌ 内部API直接使用（公式逸脱）
import 'package:flame/src/components/router/router_component.dart';
import 'package:flame/src/components/router/route.dart' as flame_route;
import 'package:flame/src/components/router/overlay_route.dart' as flame_overlay;
```

**修正方針**:
1. Flame公式ドキュメント確認: https://docs.flame-engine.org/latest/flame/router.html
2. パブリックAPIの確認: `package:flame/flame.dart`からのエクスポート確認
3. 公式推奨パターンへの移行
4. 内部インポートの完全削除

**期待する修正後**:
```dart
// ✅ 公式パブリックAPI使用
import 'package:flame/flame.dart';
// または公式で推奨される特定インポート
```

**成功条件**:
- [ ] 内部API依存の完全削除
- [ ] 公式ドキュメント記載パターンとの一致
- [ ] 動作確認（ブラウザ + iOS）
- [ ] Flameバージョンアップ耐性の確保

**リスク評価**: 🔴 極高 - 修正失敗時は全画面遷移が破綻

---

## Phase 2: 中重要度修正（1週間以内）

### 🟡 P2-1: エラーハンドリング具体化
**対象**: 全システムの汎用catch文

**修正方針**:
1. Dart公式エラーハンドリングベストプラクティス確認
2. AudioException、StateException等の具体的例外処理
3. 適切なリソース解放処理の追加

### 🟡 P2-2: AudioPlayers プリロード見直し
**対象**: `lib/framework/audio/providers/audioplayers_provider.dart:54-67`

**修正方針**:
1. audioplayers公式ドキュメント再確認: https://pub.dev/packages/audioplayers
2. 公式推奨のオーディオ管理パターン採用
3. 独自プリロード実装の削除または正当化

---

## Phase 3: 長期改善（1ヶ月以内）

### 🟢 P3-1: Provider配置パターン最適化
**修正方針**:
1. Flutter公式Provider配置ベストプラクティス確認
2. MultiProvider導入検討

### 🟢 P3-2: 独自抽象化レイヤー簡素化検討
**修正方針**:
1. 複雑性 vs 柔軟性のトレードオフ評価
2. Flutter標準パターンとの統合検討

---

## 作業実行ルール

### 各Phase開始前の必須手順
1. **公式ドキュメント精読**: 該当システムの公式ドキュメント確認
2. **ベストプラクティス調査**: 推奨パターンの特定
3. **修正計画具体化**: 具体的な修正手順の明文化
4. **リスク評価**: 破綻可能性の事前評価

### 作業中断条件
以下の場合は作業を停止し、ユーザー判断を仰ぐ：
1. **公式ドキュメントに推奨パターンが見つからない場合**
2. **修正により既存機能が破綻する可能性が高い場合**
3. **複数の修正方針が存在し選択が困難な場合**
4. **想定外の技術的制約が発見された場合**

### 修正完了条件
各修正について以下を満たすこと：
1. **公式ドキュメント準拠**: 記載パターンとの一致確認
2. **動作確認**: ブラウザ + iOSシミュレーターでの動作確認
3. **破綻回避**: 既存機能の正常動作維持
4. **将来安全性**: バージョンアップ耐性の確保

---

## 修正作業ログ

### Phase 1 修正状況
- [ ] P1-1: Flame内部API修正 - 未着手

### Phase 2 修正状況
- [ ] P2-1: エラーハンドリング具体化 - 未着手
- [ ] P2-2: AudioPlayers プリロード見直し - 未着手

### Phase 3 修正状況
- [ ] P3-1: Provider配置パターン最適化 - 未着手
- [ ] P3-2: 独自抽象化レイヤー簡素化検討 - 未着手

---

## 緊急時対応

### 修正作業が破綻した場合
1. **即座復旧**: `git checkout` での前バージョン復帰
2. **原因分析**: 破綻要因の特定
3. **方針再検討**: ユーザーとの方針再協議

### 公式ドキュメントが不十分な場合
1. **作業中断**: 推測実装の絶対禁止
2. **情報収集**: GitHub Issues、Community等での情報収集
3. **代替方針**: ユーザーとの代替案協議

---

## 最終目標

**公式ドキュメント準拠率**: 95%以上
**バージョンアップ耐性**: 次期メジャーバージョンでも動作保証
**メンテナンス性**: 標準パターンによる保守性向上