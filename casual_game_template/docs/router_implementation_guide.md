# RouterComponent実装ガイド

## 実装手順書

### 対象開発者
後続のAI実装作業者

### 前提条件
- `/docs/ui_architecture_official.md` 必読
- `/docs/migration_plan_uiscreenmanager_removal.md` 必読
- Flame 1.30.1 RouterComponent APIの理解

## Step-by-Step実装ガイド

### Step 1: 画面コンポーネント作成

#### 1.1 ディレクトリ構造作成
```bash
mkdir -p lib/game/screens
mkdir -p lib/game/widgets
```

#### 1.2 StartScreenComponent実装

**ファイル**: `lib/game/screens/start_screen_component.dart`

```dart
import 'package:flame/components.dart';\nimport 'package:flutter/material.dart';\nimport '../../framework/ui/ui_system.dart';\nimport '../simple_game.dart';\n\nclass StartScreenComponent extends PositionComponent {\n  @override\n  Future<void> onLoad() async {\n    await super.onLoad();\n    \n    final game = findGame()! as SimpleGame;\n    final config = game.configuration.config;\n    \n    // 背景\n    final background = RectangleComponent(\n      position: Vector2.zero(),\n      size: game.size,\n      paint: Paint()..color = Colors.indigo.withOpacity(0.3),\n    );\n    background.priority = UILayerPriority.background;\n    add(background);\n    \n    // タイトルテキスト\n    final titleText = TextUIComponent(\n      text: config.getStateText('start'),\n      styleId: 'xlarge',\n      position: Vector2(game.size.x / 2, game.size.y / 2 - 50),\n    );\n    titleText.anchor = Anchor.center;\n    add(titleText);\n    \n    // START GAMEボタン\n    final startButton = ButtonUIComponent(\n      text: 'START GAME',\n      colorId: 'primary',\n      position: Vector2(game.size.x / 2 - 100, game.size.y / 2 + 20),\n      size: Vector2(200, 50),\n      onPressed: () {\n        game.audioManager.playSfx('success', volumeMultiplier: 1.0);\n        game.router.pushNamed('playing');\n      },\n    );\n    startButton.anchor = Anchor.topLeft;\n    add(startButton);\n    \n    // Settingsボタン\n    final settingsButton = ButtonUIComponent(\n      text: 'Settings',\n      colorId: 'secondary',\n      position: UILayoutManager.topRight(game.size, Vector2(120, 40), 20),\n      size: Vector2(120, 40),\n      onPressed: () => game.router.pushNamed('settings'),\n    );\n    settingsButton.anchor = Anchor.topLeft;\n    add(settingsButton);\n  }\n}\n```\n\n#### 1.3 PlayingScreenComponent実装\n\n**ファイル**: `lib/game/screens/playing_screen_component.dart`\n\n```dart\nimport 'package:flame/components.dart';\nimport 'package:flutter/material.dart';\nimport '../../framework/ui/ui_system.dart';\nimport '../../framework/animation/animation_system.dart';\nimport '../simple_game.dart';\nimport '../framework_integration/simple_game_states.dart';\n\nclass PlayingScreenComponent extends PositionComponent {\n  late TextUIComponent _timerText;\n  late GameComponent _testCircle;\n  \n  @override\n  Future<void> onLoad() async {\n    await super.onLoad();\n    \n    final game = findGame()! as SimpleGame;\n    \n    // 背景\n    final background = RectangleComponent(\n      position: Vector2.zero(),\n      size: game.size,\n      paint: Paint()..color = Colors.indigo.withOpacity(0.3),\n    );\n    background.priority = UILayerPriority.background;\n    add(background);\n    \n    // タイマー背景\n    final timerBg = RectangleComponent(\n      position: Vector2(game.size.x / 2 - 100, 25),\n      size: Vector2(200, 50),\n      paint: Paint()..color = Colors.black.withOpacity(0.8),\n    );\n    add(timerBg);\n    \n    // タイマーテキスト\n    _timerText = TextUIComponent(\n      text: 'TIME: 5.0',\n      styleId: 'xlarge',\n      position: Vector2(game.size.x / 2, 50),\n    );\n    _timerText.anchor = Anchor.center;\n    _timerText.setTextColor(Colors.white);\n    add(_timerText);\n    \n    // ゲームオブジェクト\n    _testCircle = GameComponent(\n      position: Vector2(game.size.x / 2, game.size.y / 2 + 100),\n      size: Vector2(80, 80),\n      anchor: Anchor.center,\n    );\n    _testCircle.paint.color = Colors.blue;\n    _testCircle.paint.style = PaintingStyle.fill;\n    add(_testCircle);\n    \n    // 説明テキスト\n    final instructionText = TextUIComponent(\n      text: 'TAP THE BLUE CIRCLE',\n      styleId: 'medium',\n      position: Vector2(game.size.x / 2, game.size.y / 2 - 50),\n    );\n    instructionText.anchor = Anchor.center;\n    instructionText.setTextColor(Colors.white);\n    add(instructionText);\n  }\n  \n  /// タイマー表示更新（外部から呼び出し）\n  void updateTimer(double timeRemaining) {\n    if (_timerText.isMounted) {\n      _timerText.setText('TIME: ${timeRemaining.toStringAsFixed(1)}');\n      _timerText.setTextColor(Colors.white);\n    }\n  }\n  \n  /// サークルタップ処理\n  bool handleCircleTap(Vector2 tapPosition) {\n    final distance = (tapPosition - _testCircle.position).length;\n    \n    if (distance <= _testCircle.size.x / 2) {\n      AnimationPresets.buttonTap(_testCircle);\n      final game = findGame()! as SimpleGame;\n      game.audioManager.playSfx('tap', volumeMultiplier: 0.7);\n      return true;\n    }\n    return false;\n  }\n}\n```\n\n#### 1.4 GameOverScreenComponent実装\n\n**ファイル**: `lib/game/screens/game_over_screen_component.dart`\n\n```dart\nimport 'package:flame/components.dart';\nimport 'package:flutter/material.dart';\nimport '../../framework/ui/ui_system.dart';\nimport '../simple_game.dart';\n\nclass GameOverScreenComponent extends PositionComponent {\n  final int sessionCount;\n  \n  GameOverScreenComponent({required this.sessionCount});\n  \n  @override\n  Future<void> onLoad() async {\n    await super.onLoad();\n    \n    final game = findGame()! as SimpleGame;\n    final config = game.configuration.config;\n    \n    // 背景\n    final background = RectangleComponent(\n      position: Vector2.zero(),\n      size: game.size,\n      paint: Paint()..color = Colors.red.withOpacity(0.8),\n    );\n    background.priority = UILayerPriority.background;\n    add(background);\n    \n    // ゲームオーバーテキスト\n    final gameOverText = TextUIComponent(\n      text: '${config.getStateText('gameOver')}\\\\nSession: $sessionCount',\n      styleId: 'large',\n      position: Vector2(game.size.x / 2, game.size.y / 2 - 50),\n    );\n    gameOverText.anchor = Anchor.center;\n    gameOverText.setTextColor(Colors.white);\n    add(gameOverText);\n    \n    // RESTARTボタン\n    final restartButton = ButtonUIComponent(\n      text: 'RESTART',\n      colorId: 'primary',\n      position: Vector2(game.size.x / 2 - 100, game.size.y / 2 + 20),\n      size: Vector2(200, 50),\n      onPressed: () {\n        game.audioManager.playSfx('success', volumeMultiplier: 0.8);\n        game._restartGame();\n        game.router.pushNamed('playing', replace: true);\n      },\n    );\n    restartButton.anchor = Anchor.topLeft;\n    add(restartButton);\n    \n    // Settingsボタン\n    final settingsButton = ButtonUIComponent(\n      text: 'Settings',\n      colorId: 'secondary',\n      position: UILayoutManager.topRight(game.size, Vector2(120, 40), 20),\n      size: Vector2(120, 40),\n      onPressed: () => game.router.pushNamed('settings'),\n    );\n    settingsButton.anchor = Anchor.topLeft;\n    add(settingsButton);\n  }\n}\n```\n\n### Step 2: Flutter Widget作成\n\n#### 2.1 SettingsMenuWidget実装\n\n**ファイル**: `lib/game/widgets/settings_menu_widget.dart`\n\n```dart\nimport 'package:flutter/material.dart';\n\nclass SettingsMenuWidget extends StatelessWidget {\n  final void Function(String difficulty)? onDifficultyChanged;\n  final void Function()? onClosePressed;\n  \n  const SettingsMenuWidget({\n    Key? key,\n    this.onDifficultyChanged,\n    this.onClosePressed,\n  }) : super(key: key);\n  \n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      width: 300,\n      height: 400,\n      decoration: BoxDecoration(\n        color: Colors.white.withOpacity(0.95),\n        borderRadius: BorderRadius.circular(12),\n        boxShadow: [\n          BoxShadow(\n            color: Colors.black.withOpacity(0.3),\n            blurRadius: 8,\n            offset: Offset(0, 4),\n          ),\n        ],\n      ),\n      child: Column(\n        mainAxisAlignment: MainAxisAlignment.center,\n        children: [\n          // タイトル\n          Text(\n            'Settings',\n            style: TextStyle(\n              fontSize: 24,\n              fontWeight: FontWeight.bold,\n              color: Colors.black,\n            ),\n          ),\n          SizedBox(height: 40),\n          \n          // 難易度選択\n          Text(\n            'Difficulty',\n            style: TextStyle(\n              fontSize: 16,\n              color: Colors.black,\n            ),\n          ),\n          SizedBox(height: 20),\n          \n          Row(\n            mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n            children: ['Easy', 'Default', 'Hard'].map((difficulty) {\n              return ElevatedButton(\n                onPressed: () => onDifficultyChanged?.call(difficulty.toLowerCase()),\n                child: Text(difficulty),\n                style: ElevatedButton.styleFrom(\n                  backgroundColor: Colors.purple,\n                  foregroundColor: Colors.white,\n                  minimumSize: Size(70, 35),\n                ),\n              );\n            }).toList(),\n          ),\n          \n          SizedBox(height: 60),\n          \n          // 閉じるボタン\n          ElevatedButton(\n            onPressed: onClosePressed,\n            child: Text('Close'),\n            style: ElevatedButton.styleFrom(\n              backgroundColor: Colors.red,\n              foregroundColor: Colors.white,\n              minimumSize: Size(120, 40),\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n```\n\n### Step 3: SimpleGame RouterComponent統合\n\n#### 3.1 SimpleGame修正\n\n**ファイル**: `lib/game/simple_game.dart` に以下の変更を適用\n\n**A. インポート追加**:\n```dart\n// 既存インポートに追加\nimport 'package:flame/src/components/router/router_component.dart';\nimport 'screens/start_screen_component.dart';\nimport 'screens/playing_screen_component.dart';\nimport 'screens/game_over_screen_component.dart';\nimport 'widgets/settings_menu_widget.dart';\n```\n\n**B. フィールド変更**:\n```dart\nclass SimpleGame extends ConfigurableGame<GameState, SimpleGameConfig> {\n  // 削除\n  // late UIScreenManager _screenManager;\n  // Component? _currentScreen;\n  // RectangleComponent? _currentBackground;\n  \n  // 追加\n  late final RouterComponent router;\n  late PlayingScreenComponent? _playingScreen;\n  \n  // 既存フィールド\n  late TextUIComponent _statusText;\n  late GameComponent _testCircle;\n  late ParticleEffectManager _particleEffectManager;\n  late ButtonUIComponent _settingsButton;\n  int _sessionCount = 0;\n  bool _hasPlayingAnimationRun = false;\n  bool _bgmStarted = false;\n}\n```\n\n**C. onLoad修正**:\n```dart\n@override\nFuture<void> onLoad() async {\n  await super.onLoad();\n  \n  // RouterComponent初期化\n  router = RouterComponent(\n    routes: _createRoutes(),\n    initialRoute: 'start',\n  );\n  add(router);\n  \n  // パーティクルエフェクトマネージャー\n  _particleEffectManager = ParticleEffectManager();\n  _particleEffectManager.priority = UILayerPriority.gameContent;\n  add(_particleEffectManager);\n  \n  // テスト用ゲームオブジェクト（使用しない）\n  _testCircle = GameComponent(\n    position: Vector2(size.x / 2, size.y / 2 + 100),\n    size: Vector2(80, 80),\n    anchor: Anchor.center,\n  );\n  _testCircle.paint.color = Colors.blue;\n  _testCircle.paint.style = PaintingStyle.fill;\n}\n```\n\n**D. ルート作成メソッド追加**:\n```dart\nMap<String, Route> _createRoutes() {\n  return {\n    'start': Route(() => StartScreenComponent()),\n    'playing': Route(() {\n      _playingScreen = PlayingScreenComponent();\n      return _playingScreen!;\n    }),\n    'gameOver': Route(() => GameOverScreenComponent(sessionCount: _sessionCount)),\n    'settings': OverlayRoute(_buildSettingsDialog),\n  };\n}\n\nWidget _buildSettingsDialog(BuildContext context, Game game) {\n  return Container(\n    color: Colors.black.withOpacity(0.8), // 背景マスク\n    child: Center(\n      child: SettingsMenuWidget(\n        onDifficultyChanged: (difficulty) {\n          _applyConfiguration(difficulty);\n          router.pop();\n        },\n        onClosePressed: () => router.pop(),\n      ),\n    ),\n  );\n}\n```\n\n**E. 状態遷移修正**:\n```dart\nvoid _startGame() {\n  audioManager.playSfx('success', volumeMultiplier: 1.0);\n  \n  final config = configuration.config;\n  (stateProvider as SimpleGameStateProvider).startGame(config.gameDuration.inMilliseconds / 1000.0);\n  \n  timerManager.addTimer('main', TimerConfiguration(\n    duration: config.gameDuration,\n    type: TimerType.countdown,\n    onComplete: () => _endGame(),\n  ));\n  \n  timerManager.getTimer('main')?.start();\n  _sessionCount++;\n  \n  // RouterComponentによる画面遷移\n  router.pushNamed('playing');\n}\n\nvoid _restartGame() {\n  audioManager.playSfx('success', volumeMultiplier: 0.8);\n  \n  final config = configuration.config;\n  (stateProvider as SimpleGameStateProvider).restart(config.gameDuration.inMilliseconds / 1000.0);\n  \n  timerManager.addTimer('main', TimerConfiguration(\n    duration: config.gameDuration,\n    type: TimerType.countdown,\n    onComplete: () => _endGame(),\n  ));\n  \n  timerManager.getTimer('main')?.start();\n  _sessionCount++;\n}\n\nvoid _endGame() {\n  final finalTime = timerManager.getTimer('main')?.current.inMilliseconds ?? 0;\n  audioManager.playSfx('error', volumeMultiplier: 0.9);\n  \n  (stateProvider as SimpleGameStateProvider).updateTimer(0.0);\n  \n  // ゲームオーバー画面遷移\n  router.pushNamed('gameOver');\n}\n```\n\n**F. update修正**:\n```dart\n@override\nvoid update(double dt) {\n  final mainTimer = timerManager.getTimer('main');\n  if (mainTimer != null && mainTimer.isRunning) {\n    mainTimer.update(dt);\n    \n    if (stateProvider.currentState is SimpleGamePlayingState) {\n      final remaining = mainTimer.current.inMilliseconds / 1000.0;\n      (stateProvider as SimpleGameStateProvider).updateTimer(remaining);\n      \n      // PlayingScreenComponentのタイマー更新\n      if (_playingScreen != null && _playingScreen!.isMounted) {\n        _playingScreen!.updateTimer(remaining);\n      }\n      \n      if (remaining <= 0) {\n        _endGame();\n      }\n    }\n  }\n  \n  super.update(dt);\n}\n```\n\n**G. タップ処理修正**:\n```dart\n@override\nvoid onTapDown(TapDownEvent event) {\n  final state = stateProvider.currentState;\n  final tapPosition = event.canvasPosition;\n  \n  if (state is SimpleGamePlayingState) {\n    // PlayingScreenComponentのサークルタップ処理\n    if (_playingScreen != null && _playingScreen!.isMounted) {\n      _playingScreen!.handleCircleTap(tapPosition);\n    }\n  }\n}\n```\n\n**H. 削除メソッド**:\n```dart\n// 以下のメソッドを削除\n// void _createStartScreen() { ... }\n// void _createPlayingScreen() { ... }\n// void _createGameOverScreen() { ... }\n// void _onStateChanged() { ... }\n// void _handleStartScreenTap(Vector2 tapPosition) { ... }\n// void _handleGameOverScreenTap(Vector2 tapPosition) { ... }\n```\n\n### Step 4: 状態管理修正\n\n#### 4.1 SimpleGameStateProvider修正\n\n**ファイル**: `lib/game/framework_integration/simple_game_states.dart`\n\n状態遷移時のRouterComponent連携は上記SimpleGame側で実装済みのため、StateProvider側の修正は不要。\n\n### Step 5: 廃止コード削除\n\n#### 5.1 UIScreenManager削除\n\n**ファイル**: `lib/framework/ui/ui_system.dart`\n\n**削除対象**:\n- `class ModalOverlayComponent` (line 254-361)\n- `class UIScreenManager` (line 365-459)\n\n**注意**: 他のUIコンポーネント（`TextUIComponent`, `ButtonUIComponent`等）は残す\n\n#### 5.2 インポート修正\n\n**ファイル**: `lib/game/simple_game.dart`\n\n```dart\n// 修正前\nimport '../framework/ui/ui_system.dart';\n\n// 修正後（UIScreenManager部分を除去、必要な部分のみインポート）\nimport '../framework/ui/ui_system.dart'; // TextUIComponent, ButtonUIComponent用\n```\n\n### Step 6: テスト実装\n\n#### 6.1 画面コンポーネントテスト\n\n**ファイル**: `test/game/screens/start_screen_component_test.dart`\n\n```dart\nimport 'package:flutter_test/flutter_test.dart';\nimport 'package:flame/game.dart';\nimport 'package:flame/components.dart';\nimport '../../../lib/game/screens/start_screen_component.dart';\nimport '../../../lib/game/simple_game.dart';\n\nvoid main() {\n  group('StartScreenComponent', () {\n    late SimpleGame game;\n    late StartScreenComponent component;\n    \n    setUp(() {\n      game = SimpleGame();\n      component = StartScreenComponent();\n    });\n    \n    test('should load without errors', () async {\n      await game.add(component);\n      await game.ready();\n      \n      expect(component.isMounted, isTrue);\n    });\n    \n    test('should contain start button', () async {\n      await game.add(component);\n      await game.ready();\n      \n      final buttons = component.children.query<ButtonUIComponent>();\n      final startButton = buttons.firstWhere(\n        (button) => button.text == 'START GAME',\n      );\n      \n      expect(startButton, isNotNull);\n    });\n  });\n}\n```\n\n#### 6.2 RouterComponentテスト\n\n**ファイル**: `test/game/simple_game_router_test.dart`\n\n```dart\nimport 'package:flutter_test/flutter_test.dart';\nimport '../../lib/game/simple_game.dart';\n\nvoid main() {\n  group('SimpleGame RouterComponent', () {\n    late SimpleGame game;\n    \n    setUp(() {\n      game = SimpleGame();\n    });\n    \n    test('should initialize with start route', () async {\n      await game.ready();\n      \n      expect(game.router.currentRoute.name, equals('start'));\n    });\n    \n    test('should navigate to playing screen', () async {\n      await game.ready();\n      \n      game.router.pushNamed('playing');\n      \n      expect(game.router.currentRoute.name, equals('playing'));\n    });\n    \n    test('should show settings modal', () async {\n      await game.ready();\n      \n      game.router.pushNamed('settings');\n      \n      expect(game.router.currentRoute.name, equals('settings'));\n    });\n    \n    test('should navigate to game over screen', () async {\n      await game.ready();\n      \n      game.router.pushNamed('gameOver');\n      \n      expect(game.router.currentRoute.name, equals('gameOver'));\n    });\n  });\n}\n```\n\n### Step 7: 完了確認\n\n#### 7.1 テスト実行\n\n```bash\n# 単体テスト\nflutter test test/game/screens/\nflutter test test/game/simple_game_router_test.dart\n\n# 全テスト\nflutter test\n```\n\n**期待結果**: 全テストPASS\n\n#### 7.2 ブラウザシミュレーション\n\n```bash\nflutter run -d chrome\n```\n\n**確認項目**:\n1. **初期表示**: スタート画面表示\n2. **START GAMEボタン**: タップでゲーム画面遷移\n3. **ゲーム動作**: タイマー表示、サークルタップ\n4. **ゲームオーバー**: タイマー終了でゲームオーバー画面\n5. **RESTARTボタン**: タップでゲーム再スタート\n6. **Settingsボタン**: タップでモーダル表示\n7. **モーダル動作**: 背景遮断、設定変更、Close動作\n\n**期待結果**: 全項目正常動作\n\n## トラブルシューティング\n\n### よくある問題\n\n#### 1. RouterComponent not found\n**エラー**: `RouterComponent`が見つからない  \n**原因**: インポート不足  \n**解決**: `import 'package:flame/src/components/router/router_component.dart';` 追加\n\n#### 2. Route builder error\n**エラー**: Route builderでコンポーネント作成失敗  \n**原因**: コンポーネントの依存関係問題  \n**解決**: `findGame()`でゲームインスタンス取得確認\n\n#### 3. Timer update not working\n**エラー**: PlayingScreenでタイマー表示更新されない  \n**原因**: `_playingScreen`参照が`null`  \n**解決**: Route builder内で`_playingScreen`への参照設定確認\n\n#### 4. Modal background not working  \n**エラー**: SettingsモーダルでBackground tapが効かない  \n**原因**: Flutter Widget内でのタップ処理  \n**解決**: `GestureDetector`でBackground containerをラップ\n\n### デバッグ手順\n\n#### Step 1: ログ確認\n```dart\n// RouterComponent navigation log\nrouter.pushNamed('playing');\nprint('Current route: ${router.currentRoute.name}');\n```\n\n#### Step 2: コンポーネント状態確認\n```dart\n// Component mount status\nprint('Component mounted: ${component.isMounted}');\nprint('Component children: ${component.children.length}');\n```\n\n#### Step 3: Game状態確認\n```dart\n// Game state\nprint('Current state: ${stateProvider.currentState.name}');\nprint('Timer running: ${timerManager.getTimer('main')?.isRunning}');\n```\n\n## 実装チェックリスト\n\n### 必須項目\n\n- [ ] StartScreenComponent実装・テスト\n- [ ] PlayingScreenComponent実装・テスト  \n- [ ] GameOverScreenComponent実装・テスト\n- [ ] SettingsMenuWidget実装・テスト\n- [ ] SimpleGame RouterComponent統合\n- [ ] 状態遷移ロジック修正\n- [ ] タップ処理修正\n- [ ] タイマー更新修正\n- [ ] UIScreenManager削除\n- [ ] ModalOverlayComponent削除\n- [ ] 不要メソッド削除\n- [ ] 単体テスト実行・PASS\n- [ ] 統合テスト実行・PASS\n- [ ] ブラウザシミュレーション確認\n\n### 品質確認\n\n- [ ] モーダル表示時の背景要素完全遮断\n- [ ] 画面遷移の正常動作\n- [ ] タイマー表示の正常更新\n- [ ] ボタンタップの正常動作\n- [ ] 音声再生の正常動作\n- [ ] 設定変更の正常動作\n- [ ] パフォーマンス非劣化\n- [ ] メモリリークなし\n\n## 完了条件（CLAUDE.md準拠）\n\n### 1. テスト成功\n- 画面コンポーネント単体テスト: 100% PASS\n- RouterComponent統合テスト: 100% PASS\n- 既存機能回帰テスト: 100% PASS\n\n### 2. シミュレーション成功\n- Chrome ブラウザでの完全動作確認\n- 全画面遷移の正常動作\n- モーダル表示・非表示の正常動作\n\n### 3. 問題なし確認  \n- モーダル表示時の背景要素完全遮断\n- 既存機能の非劣化\n- パフォーマンス非劣化\n\n---\n\n**文書バージョン**: 1.0  \n**作成日**: 2025-08-01  \n**対象**: RouterComponent実装作業者