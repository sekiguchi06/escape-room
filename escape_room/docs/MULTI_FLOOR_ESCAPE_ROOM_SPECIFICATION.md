# 多階層脱出ゲーム実装仕様書

**作成日**: 2025-08-23  
**ステータス**: 設計段階  
**概要**: 1階・地下・隠し部屋・最終謎部屋を含む多階層脱出ゲームシステム

## 📋 ゲーム全体構造

### 階層構成
- **1階**: 5部屋 + 隠し部屋A・B
- **地下**: 5部屋 + 隠し部屋C・D  
- **最終謎部屋**: 地下右奥の先

### プレイフロー概要
1. **1階探索**: 基本5個アイテム収集・組み合わせで1階クリア
2. **地下解放**: 1階クリア後、地下アクセス可能
3. **地下探索**: 地下5個アイテム収集・組み合わせ
4. **最終謎解放**: 全アイテム消費後、最終謎部屋アクセス
5. **最終謎**: 隠れアイテム再収集で最終クリア

## 🏠 1階 部屋構成

### 基本5部屋（既存）
- **leftmost** (最左端): 地下通路
- **left** (左): 回廊  
- **center** (中央): 図書館
- **right** (右): 錬金術室
- **rightmost** (最右端): 宝物庫

### 隠し部屋
- **隠し部屋A**: leftまたはleftmostの特定ホットスポットから入室
- **隠し部屋B**: rightまたはrightmostの特定ホットスポットから入室

### 1階アイテム配置（最大5個）
```
left_stone_pillar: ancient_stone      (古い石)
back_light_source: light_crystal      (光のクリスタル)  
left_wall_secret: secret_key          (秘密の鍵)
center_main_shelf: alchemy_tools      (錬金道具)
table_right_treasure: treasure_box    (宝の箱)
```

### 1階組み合わせルール
```
ancient_stone + light_crystal + secret_key → main_escape_key
```

## 🕳️ 地下 部屋構成

### 地下5部屋（新規実装）
- **underground_leftmost**: 地下最左端
- **underground_left**: 地下左
- **underground_center**: 地下中央（エントランス）
- **underground_right**: 地下右
- **underground_rightmost**: 地下最右端

### 地下隠し部屋
- **隠し部屋C**: 地下左側の特定ホットスポットから入室
- **隠し部屋D**: 地下右側の特定ホットスポットから入室

### 地下アイテム配置（最大5個）
```
underground_crystal_formation: dark_crystal     (闇のクリスタル)
underground_ancient_altar: ritual_stone        (儀式の石)
underground_water_source: pure_water           (清浄な水)
underground_rune_wall: ancient_rune            (古代ルーン)
underground_treasure_vault: underground_key    (地下の鍵)
```

### 地下組み合わせルール
```
dark_crystal + ritual_stone + pure_water → underground_master_key
```

## 🎯 最終謎部屋

### アクセス条件
- 1階・地下の全アイテムを消費済み
- 全組み合わせ完了済み
- 地下rightmostから最終謎部屋へのパスが開放

### 最終謎解決フロー
1. **最終謎部屋進入**: 既存アイテム全消費済み状態
2. **隠れアイテム収集**: 各階のホットスポットに隠れフラグアイテム出現
3. **最終組み合わせ**: 隠れアイテムで最終脱出鍵作成
4. **ゲームクリア**: 最終脱出鍵で脱出成功

### 隠れアイテム（最終謎用）
```
1階隠れアイテム:
- hidden_emblem_a: 紋章A (隠し部屋Aで取得)
- hidden_emblem_b: 紋章B (隠し部屋Bで取得)
- hidden_core_key: 核心の鍵 (centerの隠しホットスポット)

地下隠れアイテム:
- hidden_seal_c: 封印C (隠し部屋Cで取得)  
- hidden_seal_d: 封印D (隠し部屋Dで取得)
```

### 最終組み合わせルール
```
hidden_emblem_a + hidden_emblem_b + hidden_core_key + 
hidden_seal_c + hidden_seal_d → ultimate_escape_key
```

## 🚪 部屋間移動システム

### 1階移動
- **通常移動**: 左右矢印で基本5部屋間移動
- **隠し部屋進入**: 特定ホットスポットタップで隠し部屋A・B進入
- **隠し部屋内**: 上下矢印で戻るのみ（左右移動不可）
- **地下アクセス**: 1階クリア後、rightmostから地下中央へ

### 地下移動  
- **通常移動**: 左右矢印で地下5部屋間移動
- **隠し部屋進入**: 特定ホットスポットタップで隠し部屋C・D進入
- **隠し部屋内**: 上下矢印で戻るのみ（左右移動不可）
- **1階アクセス**: underground_centerから1階rightmostへ戻る
- **最終謎アクセス**: 全クリア後、underground_rightmostから最終謎部屋へ

### ナビゲーション状態管理
```dart
enum FloorType {
  floor1,           // 1階
  underground,      // 地下
  hiddenRoomA,      // 隠し部屋A  
  hiddenRoomB,      // 隠し部屋B
  hiddenRoomC,      // 隠し部屋C
  hiddenRoomD,      // 隠し部屋D
  finalPuzzleRoom,  // 最終謎部屋
}

enum RoomType {
  // 1階
  leftmost, left, center, right, rightmost,
  // 地下  
  underground_leftmost, underground_left, underground_center, 
  underground_right, underground_rightmost,
  // 特殊部屋
  hiddenA, hiddenB, hiddenC, hiddenD, finalPuzzle,
}
```

## 🎮 実装技術要件

### 1. 部屋システム拡張
- 既存の5部屋システムを10部屋+6特殊部屋に拡張
- FloorType・RoomTypeの状態管理実装
- 階層間移動ロジック実装

### 2. ホットスポット拡張
- 地下5部屋 × 平均3個 = 15個の新ホットスポット
- 隠し部屋6部屋 × 平均2個 = 12個の新ホットスポット
- 隠し部屋進入用ホットスポット実装

### 3. アイテムシステム拡張
- 地下アイテム5個の新規実装
- 隠れアイテム5個の条件付き出現システム
- 階層別アイテム管理システム

### 4. 組み合わせシステム拡張
- 地下組み合わせルール追加
- 最終組み合わせルール追加
- 段階的組み合わせフロー管理

### 5. UI/UX拡張
- 階層表示システム（1階/地下表示）
- 隠し部屋専用ナビゲーション（上下矢印のみ）
- 進行状況表示システム

### 6. 背景画像要件
- 地下5部屋の400x600背景画像
- 隠し部屋6部屋の400x600背景画像  
- 最終謎部屋の400x600背景画像
- 計12枚の新規背景画像が必要

### 7. プログレス管理
- 1階クリア状態管理
- 地下解放条件管理
- 最終謎解放条件管理
- 隠れアイテム出現条件管理

## 📊 ゲーム進行フロー詳細

### Phase 1: 1階探索
1. 基本5部屋でアイテム5個収集
2. 隠し部屋A・B探索（アイテムなし）
3. 3個アイテム組み合わせで脱出鍵作成
4. 1階クリア → 地下アクセス解放

### Phase 2: 地下探索  
1. 地下5部屋でアイテム5個収集
2. 隠し部屋C・D探索（アイテムなし）
3. 3個アイテム組み合わせで地下鍵作成
4. 地下クリア → 最終謎部屋アクセス解放

### Phase 3: 最終謎解決
1. 全アイテム消費済み状態で最終謎部屋進入
2. 各階の隠しホットスポットに隠れアイテム出現
3. 隠れアイテム5個収集
4. 5個組み合わせで究極脱出鍵作成
5. 最終脱出成功

## 🔧 開発優先順位

### 高優先（Phase 1）
1. FloorType・RoomType拡張実装
2. 地下5部屋のホットスポット定義
3. 地下アイテムシステム実装
4. 階層間移動システム実装

### 中優先（Phase 2）
1. 隠し部屋システム実装
2. 隠し部屋進入ホットスポット実装
3. 地下背景画像配置（仮画像でも可）
4. 地下組み合わせルール実装

### 低優先（Phase 3）
1. 最終謎部屋システム実装
2. 隠れアイテム条件付き出現システム
3. 最終組み合わせシステム実装
4. 全背景画像の最終調整

## 🎯 完了基準

### Phase 1完了基準
- [ ] 1階から地下への移動が正常動作
- [ ] 地下5部屋のホットスポットが配置済み
- [ ] 地下アイテム5個が取得可能
- [ ] 階層表示システムが動作

### Phase 2完了基準  
- [ ] 隠し部屋A・B・C・Dへの進入が可能
- [ ] 隠し部屋から元の部屋への復帰が可能
- [ ] 地下組み合わせルールが動作
- [ ] 最終謎部屋へのアクセスが解放

### Phase 3完了基準
- [ ] 隠れアイテムが条件付きで出現
- [ ] 最終組み合わせが実行可能
- [ ] 究極脱出鍵で最終クリア可能
- [ ] 全フローが正常動作

## ⚠️ 制約・注意事項

### アイテム制限厳守
- 各階層で最大5個アイテム制限を維持
- 組み合わせ実行でアイテム数削減
- 隠れアイテムも最大5個制限内

### UI一貫性
- 既存UIコンポーネントとの整合性維持
- ResponsiveHotspotComponent活用
- 400x600背景画像統一

### パフォーマンス考慮
- 部屋数増加によるメモリ使用量管理
- ホットスポット描画最適化
- 状態管理システムの軽量化

### 既存機能との互換性
- 既存セーブデータとの互換性考慮
- 既存テストケースの動作保証
- 既存アイテム・組み合わせシステムとの統合

---

この仕様書に基づいて段階的実装を進行し、各Phase完了時に動作確認とテストを実施する予定です。