import 'package:flutter/material.dart';
import 'hint_dialog.dart';
import '../escape_room.dart';
import 'room_navigation_system.dart';
import 'lighting_system.dart';
import 'inventory_system.dart';
import '../../screens/debug/audio_debug_screen.dart';
import '../../screens/debug/image_debug_screen.dart';
import '../../screens/debug/item_debug_screen.dart';
import '../../screens/debug/puzzle_debug_screen.dart';

/// „Ç≤„Éº„É†‰∏äÈÉ®„É°„Éã„É•„Éº„Éê„Éº
class GameMenuBar extends StatelessWidget {
  final VoidCallback? onAddItem;

  const GameMenuBar({super.key, this.onAddItem});

  /// „É°„Éã„É•„Éº„Éê„Éº„ÅÆÈ´ò„Åï„ÇíÂèñÂæóÔºà‰ªñ„ÅÆ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Åã„ÇâÂèÇÁÖßÁî®Ôºâ
  static double getHeight(BuildContext context) {
    final mediaQuery = MediaQuery.of(context);
    final safeAreaTop = mediaQuery.padding.top;
    return safeAreaTop + 60 + 24; // SafeArea + height + margin
  }

  @override
  Widget build(BuildContext context) {
    return Positioned(
      top: 0,
      left: 0,
      right: 0,
      child: SafeArea(
        child: Container(
          height: 60,
          margin: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: Colors.black.withValues(alpha: 0.7),
            borderRadius: BorderRadius.circular(30),
            border: Border.all(color: Colors.brown[400]!, width: 2),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
            children: [
              // „Éõ„Éº„É†„Éú„Çø„É≥
              _buildMenuButton(
                icon: Icons.home,
                label: '„Éõ„Éº„É†',
                onPressed: () {
                  debugPrint('üè† Home pressed - Going to game start screen');
                  // „Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÁîªÈù¢ÔºàGameSelectionScreenÔºâ„Å´Êàª„Çã
                  Navigator.of(context).pop();
                },
              ),

              // Âå∫Âàá„ÇäÁ∑ö
              Container(width: 1, height: 30, color: Colors.brown[400]),

              // „É™„Éà„É©„Ç§„Éú„Çø„É≥
              _buildMenuButton(
                icon: Icons.refresh,
                label: '„É™„Éà„É©„Ç§',
                onPressed: () {
                  debugPrint('üîÑ Retry pressed - Restarting game');
                  // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                  _showRetryConfirmDialog(context);
                },
              ),

              // Âå∫Âàá„ÇäÁ∑ö
              Container(width: 1, height: 30, color: Colors.brown[400]),

              // „Éí„É≥„Éà„Éú„Çø„É≥
              _buildMenuButton(
                icon: Icons.lightbulb_outline,
                label: '„Éí„É≥„Éà',
                onPressed: () {
                  debugPrint('üí° Hint pressed');
                  HintDialog.show(context, onAddItem);
                },
              ),

              // Âå∫Âàá„ÇäÁ∑ö
              Container(width: 1, height: 30, color: Colors.brown[400]),

              // „Éá„Éê„ÉÉ„Ç∞„Éú„Çø„É≥
              _buildMenuButton(
                icon: Icons.bug_report,
                label: '„Éá„Éê„ÉÉ„Ç∞',
                onPressed: () {
                  debugPrint('üêõ Debug pressed - Opening debug menu');
                  _showDebugMenu(context);
                },
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// „É°„Éã„É•„Éº„Éú„Çø„É≥„ÇíÊßãÁØâ
  Widget _buildMenuButton({
    required IconData icon,
    required String label,
    required VoidCallback onPressed,
  }) {
    return Expanded(
      child: InkWell(
        onTap: onPressed,
        borderRadius: BorderRadius.circular(25),
        child: SizedBox(
          height: 50,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(icon, color: Colors.white, size: 20),
              const SizedBox(height: 2),
              Text(
                label,
                style: const TextStyle(
                  color: Colors.white,
                  fontSize: 10,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  /// „É™„Éà„É©„Ç§Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
  void _showRetryConfirmDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: Colors.brown[900],
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(15),
            side: BorderSide(color: Colors.brown[400]!, width: 2),
          ),
          title: const Row(
            children: [
              Icon(Icons.refresh, color: Colors.white),
              SizedBox(width: 8),
              Text('„Ç≤„Éº„É†„Çí„É™„Çπ„Çø„Éº„Éà', style: TextStyle(color: Colors.white)),
            ],
          ),
          content: const Text(
            'ÈÄ≤Ë°åÁä∂Ê≥Å„ÅåÂ§±„Çè„Çå„Åæ„Åô„Åå„ÄÅÊú¨ÂΩì„Å´„Ç≤„Éº„É†„Çí„É™„Çπ„Çø„Éº„Éà„Åó„Åæ„Åô„ÅãÔºü',
            style: TextStyle(color: Colors.white70),
          ),
          actions: [
            TextButton(
              onPressed: () {
                Navigator.of(context).pop(); // „ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
              },
              child: Text('„Ç≠„É£„É≥„Çª„É´', style: TextStyle(color: Colors.brown[300])),
            ),
            ElevatedButton(
              onPressed: () {
                Navigator.of(context).pop(); // „ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñâ„Åò„Çã
                _restartGame(context);
              },
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.brown[600],
                foregroundColor: Colors.white,
              ),
              child: const Text('„É™„Çπ„Çø„Éº„Éà'),
            ),
          ],
        );
      },
    );
  }

  /// „Ç≤„Éº„É†„ÇíÂÆüÈöõ„Å´„É™„Çπ„Çø„Éº„Éà
  void _restartGame(BuildContext context) {
    debugPrint('üîÑ Restarting escape room game with fade transition...');

    // „Éï„Çß„Éº„Éâ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫„Åó„Å¶„É™„Çπ„Çø„Éº„Éà
    _showFadeRestartOverlay(context);
  }

  /// „Éá„Éê„ÉÉ„Ç∞„É°„Éã„É•„Éº„ÇíË°®Á§∫
  void _showDebugMenu(BuildContext context) {
    showDialog(
      context: context,
      builder: (BuildContext context) {
        return AlertDialog(
          backgroundColor: Colors.black.withValues(alpha: 0.9),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(15),
            side: BorderSide(color: Colors.green[400]!, width: 2),
          ),
          title: const Row(
            children: [
              Icon(Icons.bug_report, color: Colors.green),
              SizedBox(width: 8),
              Text('„Éá„Éê„ÉÉ„Ç∞„É°„Éã„É•„Éº', style: TextStyle(color: Colors.green)),
            ],
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              _buildDebugMenuItem(
                context,
                icon: Icons.volume_up,
                title: 'Èü≥Â£∞„Éá„Éê„ÉÉ„Ç∞',
                subtitle: 'BGM„ÉªÂäπÊûúÈü≥„ÅÆÂà∂Âæ°',
                onTap: () => _navigateToDebugScreen(context, const AudioDebugScreen()),
              ),
              const SizedBox(height: 8),
              _buildDebugMenuItem(
                context,
                icon: Icons.image,
                title: 'ÁîªÂÉè„Éá„Éê„ÉÉ„Ç∞', 
                subtitle: 'ËÉåÊôØ„Éª„Ç¢„Ç§„ÉÜ„É†ÁîªÂÉè„ÅÆÁ¢∫Ë™ç',
                onTap: () => _navigateToDebugScreen(context, const ImageDebugScreen()),
              ),
              const SizedBox(height: 8),
              _buildDebugMenuItem(
                context,
                icon: Icons.inventory,
                title: '„Ç¢„Ç§„ÉÜ„É†„Éá„Éê„ÉÉ„Ç∞',
                subtitle: '„Ç§„É≥„Éô„É≥„Éà„É™„Ç∑„Çπ„ÉÜ„É†„ÅÆÁ¢∫Ë™ç',
                onTap: () => _navigateToDebugScreen(context, const ItemDebugScreen()),
              ),
              const SizedBox(height: 8),
              _buildDebugMenuItem(
                context,
                icon: Icons.extension,
                title: '„Éë„Ç∫„É´„Éá„Éê„ÉÉ„Ç∞',
                subtitle: '„Éë„Ç∫„É´Áä∂ÊÖã„ÉªÈÄ≤Ë°å„ÅÆÁ¢∫Ë™ç',
                onTap: () => _navigateToDebugScreen(context, const PuzzleDebugScreen()),
              ),
              const SizedBox(height: 8),
              _buildDebugMenuItem(
                context,
                icon: Icons.visibility,
                title: '„Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË°®Á§∫',
                subtitle: '„Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„Éà„ÅÆÂèØË¶ñÂåñÂàáÊõø',
                onTap: () => _toggleHotspotVisibility(context),
              ),
            ],
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.of(context).pop(),
              child: Text('Èñâ„Åò„Çã', style: TextStyle(color: Colors.green[300])),
            ),
          ],
        );
      },
    );
  }

  /// „Éá„Éê„ÉÉ„Ç∞„É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÇíÊßãÁØâ
  Widget _buildDebugMenuItem(
    BuildContext context, {
    required IconData icon,
    required String title,
    required String subtitle,
    required VoidCallback onTap,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(8),
      child: Container(
        padding: const EdgeInsets.all(12),
        decoration: BoxDecoration(
          border: Border.all(color: Colors.green.withValues(alpha: 0.3)),
          borderRadius: BorderRadius.circular(8),
        ),
        child: Row(
          children: [
            Icon(icon, color: Colors.green, size: 24),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 14,
                    ),
                  ),
                  Text(
                    subtitle,
                    style: TextStyle(
                      color: Colors.grey[400],
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
            Icon(Icons.arrow_forward_ios, color: Colors.green, size: 16),
          ],
        ),
      ),
    );
  }

  /// „Éá„Éê„ÉÉ„Ç∞ÁîªÈù¢„Å´ÈÅ∑Áßª
  void _navigateToDebugScreen(BuildContext context, Widget screen) {
    Navigator.of(context).pop(); // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
    Navigator.of(context).push(
      MaterialPageRoute(builder: (context) => screen),
    );
  }

  /// „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàÂèØË¶ñÊÄß„ÇíÂàá„ÇäÊõø„Åà
  void _toggleHotspotVisibility(BuildContext context) {
    Navigator.of(context).pop(); // „É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
    
    // „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË°®Á§∫Áä∂ÊÖã„ÅÆÂàá„ÇäÊõø„Åà„ÇíÈÄöÁü•
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: const Text('„Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà„Åæ„Åó„Åü'),
        backgroundColor: Colors.green,
        duration: const Duration(seconds: 2),
      ),
    );
    
    debugPrint('üéØ Hotspot visibility toggled');
    // TODO: ÂÆüÈöõ„ÅÆ„Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË°®Á§∫Âàá„ÇäÊõø„Åà„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË£Ö
  }

  /// „Éï„Çß„Éº„ÉâÂäπÊûú‰ªò„Åç„É™„Çπ„Çø„Éº„Éà„Ç™„Éº„Éê„Éº„É¨„Ç§
  void _showFadeRestartOverlay(BuildContext context) {
    // Navigator„ÅÆÂèÇÁÖß„Çí‰∫ãÂâç„Å´ÂèñÂæó
    final navigator = Navigator.of(context);

    showDialog(
      context: context,
      barrierDismissible: false,
      barrierColor: Colors.transparent,
      builder: (BuildContext overlayContext) {
        return _FadeRestartOverlay(
          onComplete: () {
            // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            RoomNavigationSystem().resetToInitialRoom();
            LightingSystem().resetToInitialState();
            InventorySystem().initializeEmpty(); // „Ç§„É≥„Éô„É≥„Éà„É™„ÇíÁ©∫„ÅßÂàùÊúüÂåñ

            // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈñâ„Åò„Å¶„Åã„ÇâÁîªÈù¢ÈÅ∑ÁßªÔºà„Çπ„É©„Ç§„Éâ„Å™„ÅóÔºâ
            Navigator.of(overlayContext).pop();

            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÁîªÈù¢ÈÅ∑ÁßªÔºàÂç≥Â∫ß„ÅÆÁΩÆ„ÅçÊèõ„Åà„Åß„Çπ„É©„Ç§„Éâ„ÇíÈò≤„ÅêÔºâ
            Future.delayed(const Duration(milliseconds: 50), () {
              navigator.pushReplacement(
                PageRouteBuilder(
                  pageBuilder: (context, animation, secondaryAnimation) =>
                      const EscapeRoom(),
                  transitionDuration: Duration.zero, // „Çπ„É©„Ç§„Éâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Èô§Âéª
                  reverseTransitionDuration: Duration.zero,
                ),
              );
            });
          },
        );
      },
    );
  }
}

/// „Éï„Çß„Éº„Éâ„É™„Çπ„Çø„Éº„ÉàÁî®„Ç™„Éº„Éê„Éº„É¨„Ç§Widget
class _FadeRestartOverlay extends StatefulWidget {
  final VoidCallback onComplete;

  const _FadeRestartOverlay({required this.onComplete});

  @override
  State<_FadeRestartOverlay> createState() => _FadeRestartOverlayState();
}

class _FadeRestartOverlayState extends State<_FadeRestartOverlay>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _fadeAnimation;

  @override
  void initState() {
    super.initState();

    _controller = AnimationController(
      duration: const Duration(milliseconds: 800), // ÈÉ®Â±ãÁßªÂãï„Çà„ÇäÈï∑„ÇÅ
      vsync: this,
    );

    _fadeAnimation = Tween<double>(
      begin: 0.0,
      end: 1.0,
    ).animate(CurvedAnimation(parent: _controller, curve: Curves.easeInOut));

    // „Éï„Çß„Éº„ÉâÈñãÂßã
    _controller.forward().then((_) {
      // „Éï„Çß„Éº„ÉâÂÆå‰∫ÜÂæå„Å´„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÂÆüË°åÔºàmounted„ÉÅ„Çß„ÉÉ„ÇØÔºâ
      if (mounted) {
        widget.onComplete();
      }
    });
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AnimatedBuilder(
      animation: _fadeAnimation,
      builder: (context, child) {
        return Container(
          width: double.infinity,
          height: double.infinity,
          color: Colors.black.withValues(alpha: _fadeAnimation.value),
          child: _fadeAnimation.value > 0.5
              ? const Center(
                  child: CircularProgressIndicator(
                    valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                  ),
                )
              : null,
        );
      },
    );
  }
}
