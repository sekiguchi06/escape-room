import 'package:flutter/material.dart';
import 'room_hotspot_system.dart';
import 'room_navigation_system.dart';
import 'inventory_system.dart';
import '../../gen/assets.gen.dart';
import '../../framework/ui/multi_floor_navigation_system.dart';
import '../../framework/escape_room/core/room_types.dart';
import 'models/hotspot_models.dart';

/// „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË°®Á§∫„Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà
class HotspotDisplay extends StatefulWidget {
  final Size gameSize;
  final dynamic game; // EscapeRoomGame„Ç§„É≥„Çπ„Çø„É≥„Çπ

  const HotspotDisplay({super.key, required this.gameSize, this.game});

  @override
  State<HotspotDisplay> createState() => _HotspotDisplayState();
}

class _HotspotDisplayState extends State<HotspotDisplay> {
  @override
  void initState() {
    super.initState();
  }

  @override
  Widget build(BuildContext context) {
    return ListenableBuilder(
      listenable: RoomNavigationSystem(),
      builder: (context, _) {
        final hotspots = RoomHotspotSystem().getCurrentRoomHotspots(context: context);

        return Stack(
          children: hotspots.map((hotspot) {
            return _buildHotspot(hotspot);
          }).toList(),
        );
      },
    );
  }

  Widget _buildHotspot(HotspotData hotspot) {
    final left = hotspot.position.dx * widget.gameSize.width;
    final top = hotspot.position.dy * widget.gameSize.height;
    final width = hotspot.size.width * widget.gameSize.width;
    final height = hotspot.size.height * widget.gameSize.height;

    return Positioned(
      left: left,
      top: top,
      width: width,
      height: height,
      child: GestureDetector(
        onTap: () => _onHotspotTapped(hotspot),
        child: Container(
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(8),
            // „Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆËñÑ„ÅÑÂ¢ÉÁïåÁ∑öÔºàÊú¨Áï™„Åß„ÅØÂâäÈô§ÂèØËÉΩÔºâ
            border: Border.all(
              color: Colors.yellow.withValues(alpha: 0.3),
              width: 1,
            ),
          ),
          child: ClipRRect(
            borderRadius: BorderRadius.circular(8),
            child: hotspot.asset.image(
              fit: BoxFit.contain,
              errorBuilder: (context, error, stackTrace) {
                // ÁîªÂÉè„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                return Container(
                  color: Colors.amber.withValues(alpha: 0.5),
                  child: const Center(
                    child: Icon(
                      Icons.help_outline,
                      color: Colors.white,
                      size: 24,
                    ),
                  ),
                );
              },
            ),
          ),
        ),
      ),
    );
  }

  void _onHotspotTapped(HotspotData hotspot) {
    // ËÉåÊôØ„Çø„ÉÉ„Éó„Ç®„Éï„Çß„ÇØ„Éà„ÇÇÁô∫Âãï„Åï„Åõ„Çã„Åü„ÇÅ„ÄÅÊâãÂãï„ÅßInkWell„ÅÆ„Çø„ÉÉ„Éó„ÇíÂëº„Å≥Âá∫„Åó

    // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„Ç®„Éï„Çß„ÇØ„Éà„ÅØGlobalTapDetector„ÅåËá™ÂãïÁöÑ„Å´Âá¶ÁêÜ

    // „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàÊìç‰Ωú„ÇíË®òÈå≤ÔºàRoomHotspotSystem„ÅÆonTap„ÅßÂá¶ÁêÜ„Åï„Çå„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ‰∏çË¶ÅÔºâ

    // ÁâπÂà•„Å™„ÇÆ„Éü„ÉÉ„ÇØÂá¶ÁêÜ
    if (widget.game != null) {
      _handleSpecialGimmicks(hotspot);
    }

    // „Ç´„Çπ„Çø„É†„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂÆüË°åÔºà„ÉÄ„Éü„ÉºÂ∫ßÊ®ôÔºâ
    if (hotspot.onTap != null) {
      hotspot.onTap!(const Offset(0, 0)); // InkWell„Åß„ÅØÂÖ∑‰ΩìÁöÑ„Å™Â∫ßÊ®ô„ÅØ‰∏çË¶Å
    }

    // „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫Ôºà„ÇÆ„Éü„ÉÉ„ÇØÊìç‰ΩúÂèØËÉΩÁâàÔºâ
    showDialog(
      context: context,
      barrierDismissible: true, // Â§ñÂÅ¥„Çø„ÉÉ„Éó„ÅßÈñâ„Åò„Çã
      builder: (BuildContext context) {
        return _HotspotDetailModal(hotspot: hotspot);
      },
    );
  }

  /// ÁâπÂà•„Å™„ÇÆ„Éü„ÉÉ„ÇØÂá¶ÁêÜÔºà„Ç¢„Ç§„ÉÜ„É†ÁµÑ„ÅøÂêà„Çè„Åõ„Å®Ëß£Èô§Ôºâ
  void _handleSpecialGimmicks(HotspotData hotspot) {
    final game = widget.game;
    if (game == null) return;

    // ÁâπÂà•„Å™„ÇÆ„Éü„ÉÉ„ÇØ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºà„É¢„Éº„ÉÄ„É´Ë°®Á§∫„ÅÆ„ÅøÔºâ
    // „ÇÆ„Éü„ÉÉ„ÇØÁô∫Âãï„ÅØ„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Éú„Çø„É≥„ÅßÂá¶ÁêÜ
    // Èö†„ÅóÈÉ®Â±ãÈÄ≤ÂÖ•Âá¶ÁêÜ„ÅØ„É¢„Éº„ÉÄ„É´„Çø„ÉÉ„ÉóÊôÇ„Å´_onModalTap„ÅßÂá¶ÁêÜ
  }
}

/// „Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„ÉàË©≥Á¥∞„É¢„Éº„ÉÄ„É´
class _HotspotDetailModal extends StatelessWidget {
  final HotspotData hotspot;

  const _HotspotDetailModal({required this.hotspot});

  @override
  Widget build(BuildContext context) {
    final screenWidth = MediaQuery.of(context).size.width;
    final modalSize = screenWidth * 0.9; // Ê®™ÂπÖ„ÅÆ90%„ÇíÊ≠£ÊñπÂΩ¢„Å´

    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(20), // ÁîªÈù¢Á´Ø„Å®„ÅÆ‰ΩôÁôΩ
      child: SizedBox(
        width: modalSize,
        height: modalSize,
        child: GestureDetector(
          onTap: () => _onModalTap(context),
          child: Container(
            decoration: BoxDecoration(
              color: Colors.brown[800],
              borderRadius: BorderRadius.circular(15),
              border: Border.all(color: Colors.amber[700]!, width: 2),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.7),
                  blurRadius: 20,
                  offset: const Offset(0, 10),
                ),
              ],
            ),
            child: Padding(
              padding: const EdgeInsets.all(3),
              child: ClipRRect(
                borderRadius: BorderRadius.circular(12),
                child: hotspot.asset.image(
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return Container(
                      color: Colors.brown[200],
                      child: Center(
                        child: Column(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(
                              Icons.help_outline,
                              size: 50,
                              color: Colors.brown[600],
                            ),
                            const SizedBox(height: 8),
                            Text(
                              'IMAGE NOT FOUND',
                              style: TextStyle(
                                color: Colors.brown[600],
                                fontSize: 12,
                              ),
                            ),
                            Text(
                              hotspot.id,
                              style: TextStyle(
                                color: Colors.brown[600],
                                fontSize: 10,
                              ),
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  /// „ÇÆ„Éü„ÉÉ„ÇØÂÆüË°åÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
  bool _canExecuteGimmick() {
    final inventorySystem = InventorySystem();
    switch (hotspot.id) {
      case 'treasure_chest':
        return inventorySystem.inventory.contains('master_key');
      case 'entrance_door':
        return inventorySystem.inventory.contains('escape_key');
      default:
        return false;
    }
  }

  /// „ÇÆ„Éü„ÉÉ„ÇØÂÆüË°å
  void _executeGimmick(BuildContext context) {
    if (!_canExecuteGimmick()) return;

    final inventorySystem = InventorySystem();

    switch (hotspot.id) {
      case 'treasure_chest':
        // ÂÆùÁÆ±„ÅÆ„ÇÆ„Éü„ÉÉ„ÇØËß£Èô§
        final success = inventorySystem.addItem('escape_key');
        if (success) {
          // master_key„ÇíÊ∂àË≤ª
          inventorySystem.removeItemById('master_key');

          debugPrint('üóùÔ∏è ËÑ±Âá∫„ÅÆÈçµ„ÇíÂèñÂæó„Åó„Åæ„Åó„ÅüÔºÅmaster_key„ÇíÊ∂àË≤ª');
          RoomHotspotSystem().notifyItemDiscovered(
            itemId: 'escape_key',
            itemName: 'ËÑ±Âá∫„ÅÆÈçµ',
            description: 'ÂÆùÁÆ±„Åã„ÇâÂèñ„ÇäÂá∫„Åó„ÅüÊúÄÁµÇÁöÑ„Å™ËÑ±Âá∫„ÅÆÈçµ„ÄÇ„Åì„Çå„ÅßÂüé„Åã„ÇâËÑ±Âá∫„Åß„Åç„ÇãÔºÅ',
            itemAsset: Assets.images.items.key,
          );

          Navigator.of(context).pop();
          _showGimmickSuccessMessage(context, 'ÂÆùÁÆ±„ÅåÈñã„ÅÑ„ÅüÔºÅÊúÄÁµÇÁöÑ„Å™ËÑ±Âá∫„ÅÆÈçµ„ÇíÁô∫Ë¶ãÔºÅ');
        }
        break;

      case 'entrance_door':
        // Êââ„ÅÆ„ÇÆ„Éü„ÉÉ„ÇØËß£Èô§
        // escape_key„ÇíÊ∂àË≤ª
        inventorySystem.removeItemById('escape_key');

        debugPrint('üéâ ËÑ±Âá∫ÊàêÂäüÔºÅ„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅescape_key„ÇíÊ∂àË≤ª');
        Navigator.of(context).pop();
        _showGameClearMessage(context);
        break;
    }
  }

  /// „ÇÆ„Éü„ÉÉ„ÇØÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
  void _showGimmickSuccessMessage(BuildContext context, String message) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: Colors.brown[800],
        title: Text(
          'üîì „ÇÆ„Éü„ÉÉ„ÇØËß£Èô§ÊàêÂäüÔºÅ',
          style: TextStyle(
            color: Colors.amber[200],
            fontWeight: FontWeight.bold,
          ),
        ),
        content: Text(message, style: TextStyle(color: Colors.brown[100])),
        actions: [
          ElevatedButton(
            onPressed: () => Navigator.of(context).pop(),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.amber[700],
              foregroundColor: Colors.brown[800],
            ),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  }

  /// „Ç≤„Éº„É†„ÇØ„É™„Ç¢„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
  void _showGameClearMessage(BuildContext context) {
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        backgroundColor: Colors.amber[800],
        title: Text(
          'üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ',
          style: TextStyle(
            color: Colors.brown[800],
            fontWeight: FontWeight.bold,
            fontSize: 24,
          ),
        ),
        content: Text(
          'ËÑ±Âá∫ÊàêÂäüÔºÅ\nÂüé„Åã„ÇâÁÑ°‰∫ã„Å´ËÑ±Âá∫„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åó„ÅüÔºÅ',
          style: TextStyle(color: Colors.brown[700], fontSize: 16),
          textAlign: TextAlign.center,
        ),
        actions: [
          ElevatedButton(
            onPressed: () {
              Navigator.of(context).pop();
              // „Ç≤„Éº„É†„É™„Çπ„Çø„Éº„ÉàÂá¶ÁêÜÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.brown[800],
              foregroundColor: Colors.amber[200],
            ),
            child: const Text('„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§'),
          ),
        ],
      ),
    );
  }

  /// „É¢„Éº„ÉÄ„É´ÂÜÖ„Çø„ÉÉ„ÉóÂá¶ÁêÜ
  void _onModalTap(BuildContext context) {
    final inventorySystem = InventorySystem();
    final selectedItem = inventorySystem.selectedItemId;

    switch (hotspot.id) {
      case 'underground_stairs':
        // Âú∞‰∏ã„Å∏„ÅÆÁßªÂãïÂá¶ÁêÜÔºàmain_escape_key„ÅåÂøÖË¶ÅÔºâ
        if (selectedItem == 'main_escape_key') {
          // main_escape_key„Çí‰Ωø„Å£„Å¶Âú∞‰∏ã„ÅÆÈöéÊÆµ„ÇíËß£Êîæ
          inventorySystem.removeItemById('main_escape_key');
          debugPrint('üóùÔ∏è main_escape_key„Çí‰ΩøÁî®„Åó„Å¶Âú∞‰∏ã„ÅÆÈöéÊÆµ„ÅåËß£Êîæ„Åï„Çå„Åæ„Åó„Åü');
          Navigator.of(context).pop();
        }
        // Êù°‰ª∂„ÅåÊ∫Ä„Åü„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇËµ∑„Åì„Çâ„Å™„ÅÑÔºà„É¢„Éº„ÉÄ„É´„ÇÇÈñâ„Åò„Å™„ÅÑÔºâ
        break;

      case 'treasure_chest':
        if (selectedItem == 'master_key') {
          _executeGimmick(context);
        }
        break;

      case 'entrance_door':
        if (selectedItem == 'escape_key') {
          _executeGimmick(context);
        }
        break;

      // Èö†„ÅóÈÉ®Â±ãÂÖ•Âè£„ÅÆÂá¶ÁêÜ
      case 'hidden_room_entrance_a':
        // 1Èöé„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãA„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.floor1) {
          navigationSystem.moveToRoom(RoomType.hiddenA);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãA„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå 1Èöé„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãA„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;
        
      case 'hidden_room_entrance_b':
        // 1Èöé„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãB„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.floor1) {
          navigationSystem.moveToRoom(RoomType.hiddenB);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãB„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå 1Èöé„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãB„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;
        
      case 'hidden_room_entrance_c':
        // Âú∞‰∏ã„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãC„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.underground) {
          navigationSystem.moveToRoom(RoomType.hiddenC);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãC„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå Âú∞‰∏ã„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãC„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;
        
      case 'hidden_room_entrance_d':
        // Âú∞‰∏ã„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãD„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.underground) {
          navigationSystem.moveToRoom(RoomType.hiddenD);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãD„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå Âú∞‰∏ã„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãD„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;
        
      case 'hidden_room_entrance_e':
        // 1Èöé„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãE„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.floor1) {
          navigationSystem.moveToRoom(RoomType.hiddenE);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãE„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå 1Èöé„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãE„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;
        
      case 'hidden_room_entrance_f':
        // Âú∞‰∏ã„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãF„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.underground) {
          navigationSystem.moveToRoom(RoomType.hiddenF);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãF„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå Âú∞‰∏ã„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãF„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;
        
      case 'hidden_room_entrance_g':
        // Âú∞‰∏ã„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãG„Å´ÁßªÂãï
        final navigationSystem = MultiFloorNavigationSystem();
        if (navigationSystem.currentFloor == FloorType.underground) {
          navigationSystem.moveToRoom(RoomType.hiddenG);
          debugPrint('üè† Èö†„ÅóÈÉ®Â±ãG„Å´ÁßªÂãï');
          Navigator.of(context).pop(); // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        } else {
          debugPrint('‚ùå Âú∞‰∏ã„Åß„ÅÆ„ÅøÈö†„ÅóÈÉ®Â±ãG„Å´ÁßªÂãï„Åß„Åç„Åæ„Åô');
        }
        break;

      default:
        // „Åù„ÅÆ‰ªñ„ÅÆ„Éõ„ÉÉ„Éà„Çπ„Éù„ÉÉ„Éà„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
        break;
    }
  }
}

/// „Éë„Ç∫„É´„É¢„Éº„ÉÄ„É´„ÉÄ„Ç§„Ç¢„É≠„Ç∞
class _PuzzleModalDialog extends StatefulWidget {
  final String title;
  final String description;
  final String correctAnswer;
  final VoidCallback onSuccess;
  final VoidCallback onCancel;

  const _PuzzleModalDialog({
    required this.title,
    required this.description,
    required this.correctAnswer,
    required this.onSuccess,
    required this.onCancel,
  });

  @override
  State<_PuzzleModalDialog> createState() => _PuzzleModalDialogState();
}

class _PuzzleModalDialogState extends State<_PuzzleModalDialog> {
  final TextEditingController _controller = TextEditingController();
  String _inputValue = '';

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      child: Container(
        width: 350,
        padding: const EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: Colors.brown[800],
          borderRadius: BorderRadius.circular(15),
          border: Border.all(color: Colors.amber[700]!, width: 2),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.7),
              blurRadius: 20,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // „Çø„Ç§„Éà„É´
            Text(
              widget.title,
              style: TextStyle(
                color: Colors.amber[200],
                fontSize: 20,
                fontWeight: FontWeight.bold,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 16),

            // Ë™¨Êòé
            Text(
              widget.description,
              style: TextStyle(color: Colors.brown[100], fontSize: 14),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20),

            // Êï∞Â≠óÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12),
              decoration: BoxDecoration(
                color: Colors.brown[700],
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.amber[600]!, width: 1),
              ),
              child: TextField(
                controller: _controller,
                keyboardType: TextInputType.number,
                maxLength: 4,
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: Colors.amber[100],
                  fontSize: 18,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 8,
                ),
                decoration: InputDecoration(
                  border: InputBorder.none,
                  hintText: '4Ê°Å„ÅÆÊï∞Â≠ó',
                  hintStyle: TextStyle(color: Colors.brown[400], fontSize: 16),
                  counterText: '',
                ),
                onChanged: (value) {
                  setState(() {
                    _inputValue = value;
                  });
                },
              ),
            ),
            const SizedBox(height: 20),

            // „Éú„Çø„É≥
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                ElevatedButton(
                  onPressed: widget.onCancel,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.brown[600],
                    foregroundColor: Colors.brown[100],
                  ),
                  child: const Text('„Ç≠„É£„É≥„Çª„É´'),
                ),
                ElevatedButton(
                  onPressed: _inputValue.length == 4 ? _checkAnswer : null,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.amber[700],
                    foregroundColor: Colors.brown[800],
                  ),
                  child: const Text('Á¢∫Ë™ç'),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  void _checkAnswer() {
    if (_inputValue == widget.correctAnswer) {
      // Ê≠£Ëß£
      widget.onSuccess();
    } else {
      // ‰∏çÊ≠£Ëß£
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: const Text(
            'ÈñìÈÅï„Å£„ÅüÊöóÂè∑„Åß„Åô„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ',
            style: TextStyle(color: Colors.white),
          ),
          backgroundColor: Colors.red[700],
          duration: const Duration(seconds: 2),
        ),
      );
      _controller.clear();
      setState(() {
        _inputValue = '';
      });
    }
  }
}
